services:
  tools:
    command:
      [
        "bash",
        "-lc",
        "bash Tools/Automation/workspace_inventory.sh && bash Projects/scripts/gen_docs.sh",
      ]
    build:
      context: ..
      dockerfile: Tools/Containers/tools.Dockerfile
    volumes:
      - ..:/workspace:delegated
    working_dir: /workspace

  swift:
    build:
      context: ..
      dockerfile: Tools/Containers/swift.Dockerfile
    volumes:
      - ..:/workspace:delegated
    working_dir: /workspace/Shared
    command: ["bash", "-lc", "swift test --parallel"]

  cspell:
    build:
      context: ..
      dockerfile: Tools/Containers/node-cspell.Dockerfile
    volumes:
      - ..:/workspace:delegated
    working_dir: /workspace
    command: [
        "bash",
        "-lc",
        'cspell . --config Shared/cspell.json --no-progress \
        --exclude "Tools/Automation/reports/**" \
        --exclude "Tools/Automation/Archive/**" \
        --exclude "**/.build/**" \
        --exclude "**/DerivedData/**" \
        --exclude "**/*.xcodeproj/**" \
        --exclude "**/*.xcworkspace/**" \
        --exclude "**/*.xcassets/**" \
        --exclude "**/*.lproj/**" \
        --exclude "**/__pycache__/**" || true',
      ]

  tools-all:
    build:
      context: ..
      dockerfile: Tools/Containers/ci.Dockerfile
    volumes:
      - ..:/workspace:delegated
    working_dir: /workspace
    command:
      [
        "bash",
        "-lc",
        "bash Tools/Automation/workspace_inventory.sh && bash Projects/scripts/gen_docs.sh && (cd Shared && swift package reset && swift test --parallel) && (command -v cspell >/dev/null 2>&1 && cspell . --config Shared/cspell.json --no-progress --exclude 'Tools/Automation/reports/**' --exclude 'Tools/Automation/Archive/**' --exclude '**/.build/**' --exclude '**/DerivedData/**' --exclude '**/*.xcodeproj/**' --exclude '**/*.xcworkspace/**' --exclude '**/*.xcassets/**' --exclude '**/*.lproj/**' --exclude '**/__pycache__/**' || true)",
      ]
