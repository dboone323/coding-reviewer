name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show environment
        run: |
          sw_vers
          swift --version || true

      - name: Install CocoaPods (best-effort)
        run: |
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods || true
          fi

      - name: Install pods if Podfile present
        run: |
          if [[ -f "AvoidObstaclesGame/Podfile" ]]; then
            (cd AvoidObstaclesGame && pod install) || true
          else
            echo "No Podfile; skipping pods"
          fi

      - name: Run game test script (if present)
        run: |
          if [[ -x "test_game.sh" ]]; then
            ./test_game.sh || true
          else
            echo "No executable test_game.sh; skipping"
          fi

      - name: Build and test with xcodebuild
        run: |
          set -o pipefail
          proj=$(ls *.xcodeproj 2>/dev/null | head -n1 || true)
          if [[ -n "$proj" ]]; then
            schemes=$(xcodebuild -list -project "$proj" 2>/dev/null | sed -n '/Schemes:/,$p' | tail -n +2)
            scheme=$(echo "$schemes" | head -n1 | xargs)
            if [[ -n "$scheme" ]]; then
              xcodebuild -project "$proj" -scheme "$scheme" -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 14' clean build test | tee xcodebuild.log
            else
              echo "No scheme found; skipping xcodebuild"
            fi
          else
            echo "No .xcodeproj found; skipping xcodebuild"
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: avoidobstacles-validation-logs
          path: |
            xcodebuild.log
            test_game.sh || true
