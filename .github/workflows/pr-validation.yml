name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  pr-validate:
    runs-on: macos-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'
      - name: Make Scripts Executable
        run: |
          chmod +x Tools/Automation/run_parallel_tests.sh || true
          chmod +x Tools/Automation/detect_issues.sh || true
      - name: Run Tests
        run: |
          set -e
          if [ -x Tools/Automation/run_parallel_tests.sh ]; then
            Tools/Automation/run_parallel_tests.sh
          else
            if [ -f Package.swift ]; then
              swift test --parallel
            else
              proj=$(ls -1 *.xcodeproj 2>/dev/null | head -n1)
              if [ -n "$proj" ]; then
                scheme=${proj%.xcodeproj}
                xcodebuild -scheme "$scheme" -destination 'platform=macOS' build || true
              else
                echo "No Package.swift or .xcodeproj found"
              fi
            fi
          fi
      - name: Detect Issues
        if: always()
        run: |
          [ -x Tools/Automation/detect_issues.sh ] && Tools/Automation/detect_issues.sh || echo "No detect_issues script"
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-validation-artifacts
          path: |
            test_results/
            Reports/
          retention-days: 7
